# Логика работы с повторяющимися задачами

*(группировка по действиям пользователя с проверкой типа задачи)*

## Базовые принципы

- Повторяющаяся задача хранится как **одна мастер-задача** с правилом повторения.
- Отдельные повторы **не существуют как записи** в базе данных.
- Все отображаемые повторы — **виртуальные экземпляры**.
- Любые отклонения от серии реализуются через:
  - таблицу исключений;
  - создание новых реальных задач;
  - разрыв серии.
- Данная логика **применима как для изменения, так и для удаления задач**.
- Логика должна работать **во всех интерфейсах**, включая:
  - карточку задачи;
  - окно задачи в календарном представлении;
  - drag-and-drop или изменение продолжительности прямо в сетке календаря.

---

## 1. Пользователь создаёт повторяющуюся задачу

**Действие пользователя:**  
Создание задачи с правилом повторения.

**Поведение системы:**

- Создаётся **одна мастер-задача**.
- К ней привязывается правило повторения (RRule).
- Отдельные повторения **не сохраняются** в базе данных.
- В календаре и списках:
  - виртуальные экземпляры генерируются динамически.

---

## 2. Пользователь изменяет время задачи, удаляет повтор, редактирует продолжительность или описание

**Действие пользователя:**  
Изменение времени, продолжительности, удаления задачи или внесение нового описания без изменения даты.

**Поведение системы:**  
Система определяет, что это повторяющаяся задача, и предлагает варианты изменения **с учётом типа задачи**:

### 2.0. Проверка типа задачи

- **Если это мастер-задача** → смысл варианта «этот и последующие» совпадает с «весь ряд».\
  **Предлагаются только два варианта:**
  1. Изменить / удалить **только эту задачу**
  2. Изменить / удалить **все задачи серии**

- **Если это виртуальная копия** → вариант «этот и последующие» имеет смысл.\
  **Предлагаются три варианта:**
  1. Изменить / удалить **только эту задачу**
  2. Изменить / удалить **эту задачу и последующие**
  3. Изменить / удалить **все задачи серии**

---

### 2.1. Пользователь выбирает «Изменить / удалить только эту задачу»

- В таблицу исключений добавляется запись для данного повтора, чтобы он:
  - не генерировался в исходной серии.
- Создаётся **новая самостоятельная реальная задача** (если это изменение):
  - с новым временем / продолжительностью / описанием;
  - не являющаяся повторяющейся.
- Исходная серия:
  - **не прерывается**;
  - продолжает генерировать остальные повторы.

---

### 2.2. Пользователь выбирает «Изменить / удалить эту задачу и последующие»  
*(только для виртуальной копии)*

- Исходная серия **обрывается** на повторении перед текущим.
- Изменяемая задача:
  - становится **началом новой серии** (если это изменение);
  - фактически превращается в мастер-задачу новой серии.
- Создаётся новое правило повторения:
  - с новым временем;
  - с новой датой начала;
  - с новым описанием (если оно изменено).
- Результат:
  - старая завершённая серия;
  - новая независимая серия.

---

### 2.3. Пользователь выбирает «Изменить / удалить все задачи серии»  
*(или как второй вариант для мастер-задачи)*

- Обновляются параметры **мастер-задачи** (при изменении):
  - время начала;
  - продолжительность;
  - описание (если оно изменено).
- Правило повторения пересчитывает все повторы.
- Вся серия сдвигается целиком или удаляется целиком.

---

## 3. Пользователь изменяет дату выполнения задачи

**Действие пользователя:**  
Перемещение повторяющейся задачи на другую дату (с изменением времени или без него).

**Поведение системы:**  
Система предлагает **только два варианта**:

### 3.1. Пользователь выбирает «Переместить только эту задачу»

- В таблицу исключений добавляется запись, исключающая данный повтор из серии.
- Создаётся **новая самостоятельная задача**:
  - с новой датой и временем;
  - не связанная с серией.
- Исходная серия:
  - остаётся непрерывной;
  - продолжает генерироваться.

---

### 3.2. Пользователь выбирает «Переместить эту задачу и последующие»

- Исходная серия **завершается** на предыдущем повторении.
- Перемещаемая задача становится **мастер-задачей новой серии**.
- Новая серия:
  - начинается с новой даты;
  - имеет собственное правило повторения.

---

## 4. Пользователь отмечает повторяющуюся задачу как выполненную

**Действие пользователя:**  
Установка галочки «Выполнено» на повторяющейся задаче.

**Поведение системы:**

### 4.0. Проверка незавершённых прошлых повторений

- Система проверяет, есть ли **незавершённые повторы в прошлом**.
- Если есть, пользователь получает выбор:
  1. **Отметить все предыдущие повторения как выполненные**
     - Система создаёт в таблице исключений записи для всех этих повторений со **статусом `completed`**.
  2. **Отметить все предыдущие повторения как пропущенные**
     - Система создаёт в таблице исключений записи для всех этих повторений со **статусом `archived`**.

### 4.1. Отметка текущего повтора

- В таблицу исключений добавляется запись:
  - с датой повтора;
  - со статусом `completed`.
- Мастер-задача и правило повторения **не изменяются**.
- При отображении:
  - конкретный день помечается как выполненный;
  - либо скрывается (в зависимости от фильтров).
- Если галочка снята:
  - запись из таблицы исключений удаляется;
  - повтор снова отображается как обычный.

---

## 5. Пользователь работает с обычной (неповторяющейся) задачей

**Действие пользователя:**
Любые изменения или выполнение одиночной задачи.

**Поведение системы:**

- Изменяется сама задача напрямую.
- Исключения и правила повторения **не применяются**.

---

## Итоговый принцип системы

- Система **никогда не изменяет прошлые повторы задним числом** без подтверждения пользователя.
- Любое действие пользователя приводит к одному из трёх исходов:
  1. Создание исключения.
  2. Создание новой задачи.
  3. Разделение серии.
- Поведение всегда предсказуемо и локализовано по времени.

